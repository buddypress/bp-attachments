!function(){const{template:t}=lodash;const{i18n:{__:e}}=wp,{filter:i}=lodash;var n=t=>{const i=[e("Bytes","bp-attachments"),e("KB","bp-attachments"),e("MB","bp-attachments"),e("GB","bp-attachments"),e("TB","bp-attachments")];if(0===t)return"0 "+i[0];const n=parseInt(Math.floor(Math.log(t)/Math.log(1024)),10);return 0===n?`${t} ${i[n]}`:`${(t/1024**n).toFixed(1)} ${i[n]}`};const{domReady:a}=wp;window.bp=window.bp||{},window.bp.Attachments=window.bp.Attachments||{};const s=window.bpAttachmentsActivitySettings||{};window.bp.Attachments.Activity=new class{renderItemPreview(e){var i;return(i="bp-media-preview",t(document.querySelector("#tmpl-"+i).innerHTML,{evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g,variable:"data"}))(e)}getFileInput(){let t;if(document.querySelector("#bp-attachments-activity-medium"))t=document.querySelector("#bp-attachments-activity-medium");else{t=document.createElement("input"),t.type="file",t.id="bp-attachments-activity-medium",t.name="_bp_attachments_activity_medium",t.style="display: none;",t.accept=this.allowedTypes,this.container.append(t);const e=document.createElement("div");e.id="bp-attachments-activity-medium-preview",this.container.append(e)}return t}upload(t,e){const{model:{attributes:{user_id:i}}}=t;e.addEventListener("change",(e=>{const a=e.target.files[0];if(a&&-1===this.uploadedFiles.indexOf(a.name)){this.uploadedFiles.push(a.name);const s=new FormData;s.append("file",a),s.append("action","bp_attachments_media_upload"),s.append("object","members"),s.append("object_item",i),s.append("visibility","public"),s.append("total_bytes",a.size);const o=t.model.get("errors");o&&o.origin&&"bpAttachments"===o.origin&&t.model.unset("errors"),fetch(this.endpoint,{method:"POST",body:s,headers:{"X-WP-Nonce":this.nonce}}).then((t=>t.json())).then((e=>{e.code&&e.message?t.model.set("errors",{type:"error",value:e.message,origin:"bpAttachments"}):(e.size&&(e.size=n(e.size)),document.querySelector("#bp-attachments-activity-medium-preview").innerHTML=this.renderItemPreview(e))})).finally((()=>{e.target.value=""}))}})),e.click()}reset(){this.getFileInput().value="",document.querySelector("#bp-attachments-activity-medium-preview").innerHTML=""}start(){const t=this.getFileInput();this.ActivityButtons.on("display:bpAttachments",(e=>this.upload(e,t))),this.ActivityButtons.on("resetForm:bpAttachments",(()=>this.reset())),this.container.addEventListener("click",(t=>{if("bp-attachments-activity-medium-exit"===t.target.getAttribute("id"))return t.preventDefault(),this.reset()}))}constructor({path:t,root:e,nonce:i,allowedExtTypes:n}){const{bp:{Nouveau:{Activity:{postForm:{buttons:a}}}}}=window;this.ActivityButtons=a,this.container=document.querySelector("#whats-new-textarea"),this.endpoint=e+t,this.nonce=i,this.allowedTypes=n,this.uploadedFiles=[]}}(s),a((()=>window.bp.Attachments.Activity.start()))}();
//# sourceMappingURL=activity.js.map
