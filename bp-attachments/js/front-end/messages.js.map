{"mappings":"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","sources":["src/media-library/utils/set-template.js","src/media-library/utils/functions.js","src/front-end/messages.js"],"sourcesContent":["/**\n * External dependencies\n */\nconst { template } = lodash;\n\nfunction setTemplate( tmpl ) {\n\tconst options = {\n\t\tevaluate:    /<#([\\s\\S]+?)#>/g,\n\t\tinterpolate: /\\{\\{\\{([\\s\\S]+?)\\}\\}\\}/g,\n\t\tescape:      /\\{\\{([^\\}]+?)\\}\\}(?!\\})/g,\n\t\tvariable:    'data'\n\t};\n\n\treturn template( document.querySelector( '#tmpl-' + tmpl ).innerHTML, options );\n}\n\nexport default setTemplate;\n","/**\n * WordPress dependencies\n */\nconst {\n\ti18n: {\n\t\t__,\n\t},\n} = wp;\n\n/**\n * External dependencies\n */\nconst { filter } = lodash;\n\nexport const getDirectoryAncestors = ( tree, parentId ) => {\n\tlet parents = filter( tree, { id: parentId } );\n\n\tparents.forEach( ( parent ) => {\n\t\tconst grandParents = getDirectoryAncestors( tree, parent.parent );\n\t\tparents = [ ...parents, ...grandParents ];\n\t} );\n\n\treturn parents;\n}\n\nexport const bytesToSize = ( bytes ) => {\n\tconst sizes = [\n\t\t__( 'Bytes', 'bp-attachments' ),\n\t\t__( 'KB', 'bp-attachments' ),\n\t\t__( 'MB', 'bp-attachments' ),\n\t\t__( 'GB', 'bp-attachments' ),\n\t\t__( 'TB', 'bp-attachments' ),\n\t];\n\n\tif ( bytes === 0 ) {\n\t\treturn '0 ' + sizes[0];\n\t}\n\n\tconst i = parseInt( Math.floor( Math.log( bytes ) / Math.log( 1024 ) ), 10 );\n\n\tif ( i === 0 ) {\n\t\treturn `${bytes} ${sizes[i]}`;\n\t}\n\n\treturn `${ ( bytes / ( 1024 ** i ) ).toFixed( 1 ) } ${ sizes[ i ] }`;\n}\n\nexport default bytesToSize;\n","/**\n * WordPress dependencies\n */\nconst {\n\tdomReady,\n} = wp;\n\n/**\n * Internal dependencies.\n */\nimport setTemplate from '../media-library/utils/set-template';\nimport bytesToSize from '../media-library/utils/functions';\n\nclass bpAttachmentsMessages {\n\t/**\n\t * Setup the Messages Attachments Button.\n\t *\n\t * @since 1.0.0\n\t */\n\tconstructor( { path, root, nonce, allowedExtTypes, userId } ) {\n\t\tthis.endpoint = root + path;\n\t\tthis.nonce = nonce;\n\t\tthis.allowedTypes = allowedExtTypes;\n\t\tthis.userId = userId;\n\t\tthis.uploadedFiles = [];\n\t\tthis.container = null;\n\t}\n\n\t/**\n\t * Renders the Medium preview.\n\t *\n\t * @since 1.0.0\n\t *\n\t * @param {Object} props The medium properties.\n\t * @returns {string} HTML output.\n\t */\n\t renderItemPreview( props ) {\n\t\tconst Template = setTemplate( 'bp-media-preview' );\n\t\treturn Template( props );\n\t}\n\n\t/**\n\t * Remove all Medium preview content.\n\t *\n\t * @since 1.0.0\n\t */\n\treset() {\n\t\tdocument.querySelector( '#bp-attachments-messages-medium-preview' ).innerHTML = '';\n\t}\n\n\t/**\n\t * Open the file browser and process the upload.\n\t *\n\t * @since 1.0.0\n\t */\n\t upload() {\n\t\tconst fileInput = document.createElement( 'input' );\n\t\tfileInput.type = 'file';\n\t\tfileInput.id = 'bp-attachments-messages-medium';\n\t\tfileInput.name = '_bp_attachments_messages_medium';\n\t\tfileInput.style = 'display: none;';\n\t\tfileInput.accept = this.allowedTypes;\n\n\t\t// Add the File input to the DOM & simulate a click.\n\t\tif ( ! this.container.querySelector( '#bp-attachments-messages-medium' ) ) {\n\t\t\tthis.reset();\n\t\t\tthis.container.append( fileInput );\n\t\t}\n\n\t\tfileInput.click();\n\n\t\tfileInput.addEventListener(\n\t\t\t'change',\n\t\t\t( event ) => {\n\t\t\t\tevent.preventDefault();\n\n\t\t\t\tconst medium = event.target.files[0];\n\n\t\t\t\t// Make sure to only upload once a file.\n\t\t\t\tif ( !! medium && -1 === this.uploadedFiles.indexOf( medium.name ) ) {\n\t\t\t\t\tthis.container.querySelector( '.bp-attachments-messages-file' ).style = \"visibility: hidden;\";\n\t\t\t\t\tthis.uploadedFiles.push( medium.name );\n\n\t\t\t\t\tconst formData = new FormData();\n\t\t\t\t\tformData.append( 'file', medium );\n\t\t\t\t\tformData.append( 'action', 'bp_attachments_media_upload' );\n\t\t\t\t\tformData.append( 'object', 'members' );\n\t\t\t\t\tformData.append( 'object_item', this.userId );\n\t\t\t\t\tformData.append( 'visibility', 'private' );\n\t\t\t\t\tformData.append( 'total_bytes', medium.size );\n\n\t\t\t\t\tfetch( this.endpoint, {\n\t\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\t\tbody: formData,\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t'X-WP-Nonce' : this.nonce,\n\t\t\t\t\t\t}\n\t\t\t\t\t} ).then(\n\t\t\t\t\t\t( response ) => response.json()\n\t\t\t\t\t).then(\n\t\t\t\t\t\t( data ) => {\n\t\t\t\t\t\t\tif ( data.code && data.message ) {\n\t\t\t\t\t\t\t\tconsole.log( data.message );\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif ( data.size ) {\n\t\t\t\t\t\t\t\tdata.size = bytesToSize( data.size );\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// Render the media preview.\n\t\t\t\t\t\t\tthis.container.querySelector( '#bp-attachments-messages-medium-preview' ).innerHTML = this.renderItemPreview( data );\n\t\t\t\t\t\t}\n\t\t\t\t\t).finally( () => {\n\t\t\t\t\t\tthis.container.querySelector( '#bp-attachments-messages-medium' ).remove();\n\t\t\t\t\t} );\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\t}\n\n\t/**\n\t * Init the Messages Attachments Button.\n\t *\n\t * @since 1.0.0\n\t */\n\t start() {\n\t\tconst {\n\t\t\tbp: {\n\t\t\t\tNouveau: {\n\t\t\t\t\tMessages: {\n\t\t\t\t\t\tviews,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t} = window;\n\t\t// Add the preview placeholder.\n\t\tconst previewPlaceholder = document.createElement( 'div' );\n\t\tpreviewPlaceholder.id = 'bp-attachments-messages-medium-preview';\n\n\t\tdocument.addEventListener(\n\t\t\t'click',\n\t\t\t( event ) => {\n\t\t\t\tif ( event.target.classList.contains( 'bp-attachments-messages-file' ) ) {\n\t\t\t\t\tevent.preventDefault();\n\n\t\t\t\t\tthis.container = event.target.closest( '.bp-attachments-messages-button-container' );\n\t\t\t\t\tthis.container.prepend( previewPlaceholder );\n\n\t\t\t\t\treturn this.upload();\n\t\t\t\t}\n\n\t\t\t\tif ( 'bp-attachments-medium-preview-exit' === event.target.getAttribute( 'id' ) ) {\n\t\t\t\t\tevent.preventDefault();\n\t\t\t\t\tthis.container.querySelector( '.bp-attachments-messages-file' ).style = \"visibility: visible;\";\n\n\t\t\t\t\treturn this.reset();\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\n\t\tviews.on(\n\t\t\t'compose:resetForm',\n\t\t\t() => {\n\t\t\t\tthis.reset();\n\t\t\t\tthis.container.querySelector( '.bp-attachments-messages-file' ).style = \"visibility: visible;\";\n\t\t\t}\n\t\t);\n\t}\n}\n\nwindow.bp = window.bp || {};\nwindow.bp.Attachments = window.bp.Attachments || {};\n\nconst settings = window.bpAttachmentsMessagesSettings || {};\nwindow.bp.Attachments.Messages = new bpAttachmentsMessages( settings );\n\ndomReady( () => window.bp.Attachments.Messages.start() );\n"],"names":["template","lodash","i18n","__","wp","filter","$be1cf92520ac449f$export$2e2bcd8739ae039","bytes","sizes","i","parseInt","Math","floor","log","toFixed","domReady","$d48ac7d9a051da75$var$domReady","window","bp","Attachments","$d48ac7d9a051da75$var$settings","bpAttachmentsMessagesSettings","Messages","renderItemPreview","props","tmpl","document","querySelector","innerHTML","evaluate","interpolate","escape","variable","reset","upload","fileInput","createElement","type","id","name","style","accept","this","allowedTypes","container","append","click","addEventListener","event","preventDefault","medium","target","files","uploadedFiles","indexOf","push","formData","FormData","userId","size","fetch","endpoint","method","body","headers","nonce","then","response","json","data","code","message","console","finally","remove","start","Nouveau","views","previewPlaceholder","classList","contains","closest","prepend","getAttribute","on","constructor","path","root","allowedExtTypes"],"version":3,"file":"messages.js.map"}