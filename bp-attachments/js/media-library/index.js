!function(){function e(e,t,n,r){Object.defineProperty(e,t,{get:n,set:r,enumerable:!0,configurable:!0})}const t="bp/attachments";var n={};e(n,"getSettings",(function(){return m})),e(n,"getRequestsContext",(function(){return E})),e(n,"isGridDisplayMode",(function(){return h})),e(n,"getLoggedInUser",(function(){return g})),e(n,"getFormState",(function(){return _})),e(n,"isUploading",(function(){return y})),e(n,"uploadEnded",(function(){return f})),e(n,"getUploadedFiles",(function(){return b})),e(n,"getErroredFiles",(function(){return D})),e(n,"getMedia",(function(){return T})),e(n,"getCurrentDirectory",(function(){return S})),e(n,"getCurrentDirectoryObject",(function(){return A})),e(n,"getTree",(function(){return M})),e(n,"getFlatTree",(function(){return v})),e(n,"isSelectable",(function(){return O})),e(n,"getRelativePath",(function(){return I})),e(n,"getMediumDestinationData",(function(){return L}));const{i18n:{__:r}}=wp,{filter:a}=lodash,i=(e,t)=>{let n=a(e,{id:t});return n.forEach((t=>{const r=i(e,t.parent);n=[...n,...r]})),n},s=e=>{const t=[r("Bytes","bp-attachments"),r("KB","bp-attachments"),r("MB","bp-attachments"),r("GB","bp-attachments"),r("TB","bp-attachments")];if(0===e)return"0 "+t[0];const n=parseInt(Math.floor(Math.log(e)/Math.log(1024)),10);return 0===n?`${e} ${t[n]}`:`${(e/1024**n).toFixed(1)} ${t[n]}`},{trim:o,groupBy:c,filter:d,indexOf:l,find:u,defaultTo:p}=lodash,m=e=>{const{settings:t}=e;return t},E=e=>{const{settings:{isAdminScreen:t}}=e;return!0===t?"edit":"view"},h=e=>{const{isGrid:t}=e;return t},g=e=>{const{user:t}=e;return t},_=e=>{const{formState:t}=e;return t},y=e=>{const{uploading:t}=e;return t},f=e=>{const{ended:t}=e;return t},b=e=>{const{uploaded:t}=e;return t},D=e=>{const{errored:t}=e;return t},T=e=>{const{files:t}=e;return t},S=e=>{const{currentDirectory:t}=e;return t||""},A=e=>{const{currentDirectory:t,tree:n}=e,r={readonly:!0};return""!==t?p(u(n,{id:t}),r):r},M=e=>{const{tree:t,currentDirectory:n}=e,r=c(t,"parent"),a=d(t,{parent:n||0}).map((e=>e.id));if(a&&a.length&&a.forEach((e=>{r[e]&&delete r[e]})),n){const e=i(t,n).map((e=>e.id));Object.keys(r).forEach((t=>{0!==parseInt(t,10)&&-1===l(e,t)&&delete r[t]}))}const s=e=>e.map((e=>{const t=r[e.id];return{...e,children:t&&t.length?s(t):[]}}));return s(r[0]||[])},v=e=>{const{tree:t}=e;return t||[]},O=e=>{const{isSelectable:t}=e;return t},I=e=>{const{relativePath:t}=e;return t},L=e=>{const{relativePath:t}=e;if(!t)return{object:"members"};const n=o(t,"/").split("/");return{status:n[0]?n[0]:"private",object:"groups"===n[1]?"groups":"members",item:n[2]?n[2]:""}};var R={};e(R,"setSettings",(function(){return k})),e(R,"fetchFromAPI",(function(){return B})),e(R,"createFromAPI",(function(){return H})),e(R,"deleteFromAPI",(function(){return q})),e(R,"switchDisplayMode",(function(){return Y})),e(R,"getLoggedInUser",(function(){return W})),e(R,"getMedia",(function(){return $})),e(R,"updateFormState",(function(){return z})),e(R,"createMedium",(function(){return X})),e(R,"addMedia",(function(){return K})),e(R,"initTree",(function(){return Q})),e(R,"addItemTree",(function(){return Z})),e(R,"deleteMedium",(function(){return J})),e(R,"addMediaError",(function(){return V})),e(R,"toggleSelectable",(function(){return ee})),e(R,"toggleMediaSelection",(function(){return te})),e(R,"insertMedium",(function(){return ne})),e(R,"createDirectory",(function(){return re})),e(R,"parseResponseMedia",(function(){return ae})),e(R,"requestMedia",(function(){return ie})),e(R,"destroyMedium",(function(){return se})),e(R,"removeMedium",(function(){return oe}));const P={SET_SETTINGS:"SET_SETTINGS",GET_LOGGED_IN_USER:"GET_LOGGED_IN_USER",GET_MEDIA:"GET_MEDIA",ADD_MEDIA:"ADD_MEDIA",FILL_TREE:"FILL_TREE",DESTROY_MEDIUM:"DESTROY_MEDIUM",FETCH_FROM_API:"FETCH_FROM_API",CREATE_FROM_API:"CREATE_FROM_API",DELETE_FROM_API:"DELETE_FROM_API",UPLOAD_START:"UPLOAD_START",UPLOAD_END:"UPLOAD_END",RESET_UPLOADS:"RESET_UPLOADS",ADD_ERROR:"ADD_ERROR",TOGGLE_SELECTABLE:"TOGGLE_SELECTABLE",TOGGLE_MEDIA_SELECTION:"TOGGLE_MEDIA_SELECTION",SWITCH_DISPLAY_MODE:"SWITCH_DISPLAY_MODE",UPDATE_FORM_STATE:"UPDATE_FORM_STATE"},{uniqueId:F,hasIn:N,trim:w,trimEnd:G,filter:C}=lodash,{data:{dispatch:U,select:j},url:{addQueryArgs:x}}=wp;function k(e){return{type:P.SET_SETTINGS,settings:e}}function B(e,t){return{type:P.FETCH_FROM_API,path:e,parse:t}}function H(e,t){return{type:P.CREATE_FROM_API,path:e,data:t}}function q(e,t){return{type:P.DELETE_FROM_API,path:e,relativePath:t}}function Y(e){return{type:P.SWITCH_DISPLAY_MODE,isGrid:e}}function W(e){return{type:P.GET_LOGGED_IN_USER,user:e}}function $(e,t,n){return{type:"GET_MEDIA",files:e,relativePath:t,currentDirectory:n}}function z(e){return{type:P.UPDATE_FORM_STATE,params:e}}function X(e,t){return{type:"CREATE_FROM_API",path:e,formData:t}}function K(e){return{type:"ADD_MEDIA",file:e}}function Q(e){const n=j(t).getTree(),r=C(e,{mime_type:"inode/directory"});n.length||r.forEach((e=>{U(t).addItemTree({id:e.id,slug:e.name,name:e.title,parent:0,object:e.object?e.object:"members",readonly:!!e.readonly&&e.readonly})}))}function Z(e){return{type:"FILL_TREE",item:e}}function J(e,t){return{type:"DELETE_FROM_API",path:e,relativePath:t}}function V(e){return{type:"ADD_ERROR",file:e}}function ee(e){return{type:"TOGGLE_SELECTABLE",isSelectable:e}}function te(e,t){return{type:"TOGGLE_MEDIA_SELECTION",id:e,isSelected:t}}function*ne(e){let n,r=!0;const a=j(t).getState(),{object:i,item:s,status:o}=getMediumDestinationData(a),c=a.relativePath;yield{type:"UPLOAD_START",uploading:r,file:e};const d=new FormData;d.append("file",e),d.append("action","bp_attachments_media_upload"),"groups"===i?(d.append("object",i),d.append("object_slug",s)):d.append("object_id",s),o&&d.append("status",o),w(c,"/")!==o+"/"+i+"/"+s&&d.append("parent_dir",c),r=!1;try{return n=yield X("/buddypress/v1/attachments",d),yield{type:"UPLOAD_END",uploading:r,uploaded:n},n.uploaded=!0,K(n)}catch(t){return n={id:F(),name:e.name,error:t.message},yield{type:"UPLOAD_END",uploading:r,uploaded:n},V(n)}}function*re(e){let n,r=!0,a={name:e.directoryName,type:e.directoryType};const i=j(t).getState(),{object:s,item:o,status:c}=getMediumDestinationData(i),d=i.relativePath;yield{type:"UPLOAD_START",uploading:r,file:a};const l=new FormData;l.append("directory_name",a.name),l.append("directory_type",a.type),l.append("action","bp_attachments_make_directory"),"groups"===s?(l.append("object",s),l.append("object_slug",o)):l.append("object_id",o),c&&l.append("status",c),w(d,"/")!==c+"/"+s+"/"+o&&l.append("parent_dir",d),r=!1;try{return n=yield X("/buddypress/v1/attachments",l),yield{type:"UPLOAD_END",uploading:r,uploaded:n},n.uploaded=!0,K(n)}catch(e){return n={id:F(),name:a.name,error:e.message},yield{type:"UPLOAD_END",uploading:r,uploaded:n},V(n)}}const ae=async function(e,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";const a=await e.json().then((e=>(e.forEach((e=>{e.parent=r,"inode/directory"===e.mime_type&&U(t).addItemTree({id:e.id,slug:e.name,name:e.title,parent:e.parent,object:e.object?e.object:"members",readonly:!!e.readonly&&e.readonly})})),e)));n||r||Q(a),U(t).getMedia(a,n,r)};function*ie(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const n="/buddypress/v1/attachments";let r="",a="";e.context||(e.context=j(t).getRequestsContext()),e.directory&&e.path&&(e.directory=G(e.path,"/")+"/"+e.directory),e.parent&&(a=e.parent,delete e.parent),delete e.path;const i=yield B(x(n,e),!1);return r=N(i,["headers","get"])?i.headers.get("X-BP-Attachments-Relative-Path"):get(i,["headers","X-BP-Attachments-Relative-Path"],""),ae(i,r,a)}function se(e){return{type:"DESTROY_MEDIUM",id:e}}function*oe(e){const n=j(t).getState(),{relativePath:r}=n;let a;try{return a=yield J("/buddypress/v1/attachments/"+e.id+"/",r),se(a.previous.id)}catch(t){return e.error=t.message,V(e)}}var ce={};e(ce,"getLoggedInUser",(function(){return le})),e(ce,"getMedia",(function(){return ue}));const{filter:de}=lodash;function*le(){const e=yield B("/buddypress/v1/members/me?context=edit",!0);yield W(e)}function*ue(){const e="/buddypress/v1/attachments?context="+(()=>{const{isAdminScreen:e}=window.bpAttachmentsMediaLibrarySettings||{};return e&&!0===e?"edit":"view"})(),t=yield B(e,!0);Q(t),yield $(t,"")}const{reject:pe}=lodash,me={user:{},tree:[],currentDirectory:"",files:[],relativePath:"",uploaded:[],errored:[],uploading:!1,ended:!1,isSelectable:!1,isGrid:!0,settings:{},formState:{}};var Ee=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:me,t=arguments.length>1?arguments[1]:void 0;switch(t.type){case P.SET_SETTINGS:return{...e,settings:t.settings};case P.GET_LOGGED_IN_USER:return{...e,user:t.user};case P.GET_MEDIA:return{...e,files:t.files,relativePath:t.relativePath,currentDirectory:t.currentDirectory};case P.FILL_TREE:return{...e,tree:[...pe(e.tree,["id",t.item.id]),t.item]};case P.UPDATE_FORM_STATE:return{...e,formState:t.params};case P.ADD_MEDIA:return{...e,files:[...pe(e.files,["id",t.file.id]),t.file]};case P.UPLOAD_START:return{...e,uploading:t.uploading,uploaded:[...e.uploaded,t.file]};case P.ADD_ERROR:return{...e,errored:[...e.errored,t.file]};case P.UPLOAD_END:return{...e,uploading:t.uploading,uploaded:pe(e.uploaded,(e=>e.name===t.uploaded.name||e.name===t.uploaded.title)),ended:!0};case P.RESET_UPLOADS:return{...e,uploading:!1,uploaded:[],errored:[],ended:!1};case P.TOGGLE_SELECTABLE:return{...e,isSelectable:t.isSelectable};case P.TOGGLE_MEDIA_SELECTION:return{...e,files:e.files.map((e=>(t.id===e.id&&(e.selected=t.isSelected),e)))};case P.SWITCH_DISPLAY_MODE:return{...e,isGrid:t.isGrid};case P.DESTROY_MEDIUM:return{...e,files:[...pe(e.files,["id",t.id])]}}return e};const{apiFetch:he}=wp,ge={FETCH_FROM_API(e){let{path:t,parse:n}=e;return he({path:t,parse:n})},CREATE_FROM_API(e){let{path:t,data:n}=e;return he({path:t,method:"POST",data:n})},DELETE_FROM_API(e){let{path:t,relativePath:n}=e;return he({path:t,method:"DELETE",data:{relative_path:n}})}},{data:{registerStore:_e}}=wp;_e(t,{reducer:Ee,actions:R,selectors:n,controls:ge,resolvers:ce});const ye=t,{components:{Popover:fe},data:{useDispatch:be,useSelect:De},element:{createElement:Te,Fragment:Se,useState:Ae},i18n:{__:Me}}=wp;var ve=e=>{let{settings:t}=e;const{updateFormState:n}=be(ye),r=De((e=>e(ye).getCurrentDirectoryObject()),[]),[a,i]=Ae(!1),s=!0===a?"split-button is-open":"split-button",o=!0===a?"dashicons dashicons-arrow-up-alt2":"dashicons dashicons-arrow-down-alt2",c=!0!==r.readonly,{allowedMediaTypes:d}=t,l=e=>(e.preventDefault(),n({parentDirectory:r.id,action:"upload"}));let u=[{id:"directory",text:Me("Add new directory","bp-attachments")}];d&&Object.keys(d).forEach((e=>{"image"===e?u.push({id:"album",text:Me("Add new photo album","bp-attachments")}):"audio"===e?u.push({id:"audioPlaylist",text:Me("Add new audio playlist","bp-attachments")}):"video"===e&&u.push({id:"videoPlaylist",text:Me("Add new video playlist","bp-attachments")})}));const p=u.map((e=>Te("li",{key:"type-"+e.id},Te("a",{href:"#new-bp-media-directory",className:"button-link directory-button split-button-option",onClick:t=>((e,t)=>{e.preventDefault(),console.log(t)})(t,e.id)},e.text))));return Te(Se,null,Te("h1",{className:"wp-heading-inline"},Me("Community Media Library","bp-attachments")),!!c&&Te("div",{className:s},Te("div",{className:"split-button-head"},Te("a",{href:"#new-bp-media-upload",className:"button split-button-primary","aria-live":"polite",onClick:e=>l(e)},Me("Add new","bp-attachments")),Te("button",{type:"button",className:"split-button-toggle","aria-haspopup":"true","aria-expanded":a,onClick:()=>i(!a)},Te("i",{className:o}),Te("span",{className:"screen-reader-text"},Me("More actions","bp-attachments")),a&&Te(fe,{noArrow:!1,onFocusOutside:()=>i(!a)},Te("ul",{className:"split-button-body"},Te("li",null,Te("a",{href:"#new-bp-media-upload",className:"button-link media-button split-button-option",onClick:e=>l(e)},Me("Upload media","bp-attachments"))),p))))),Te("hr",{className:"wp-header-end"}))};const{components:{DropZone:Oe,FormFileUpload:Ie},data:{useDispatch:Le,useSelect:Re},element:{createElement:Pe},i18n:{__:Fe,sprintf:Ne}}=wp;var we=e=>{let{settings:t}=e;const{updateFormState:n}=Le(ye),r=Re((e=>e(ye).getFormState()),[]),a=e=>{e.preventDefault()};return r.action&&"upload"===r.action?Pe("div",{className:"uploader-container enabled"},Pe(Oe,{label:Fe("Drop your files here.","bp-attachments"),onFilesDrop:e=>a(e),className:"uploader-inline"}),Pe("button",{className:"close dashicons dashicons-no",onClick:e=>(e=>(e.preventDefault(),r.action="",n(r)))(e)},Pe("span",{className:"screen-reader-text"},Fe("Close the upload panel","bp-attachments"))),Pe("div",{className:"dropzone-label"},Pe("h2",{className:"upload-instructions drop-instructions"},Fe("Drop files to upload","bp-attachments")),Pe("p",{className:"upload-instructions drop-instructions"},Fe("or","bp-attachments")),Pe(Ie,{onChange:e=>a(e),multiple:!0,className:"browser button button-hero"},Fe("Select Files","bp-attachments"))),Pe("div",{className:"upload-restrictions"},Pe("p",null,Ne(Fe("Maximum upload file size: %s.","bp-attachments"),s(t.maxUploadFileSize))))):null};const{find:Ge,reverse:Ce}=lodash,{element:{createElement:Ue,useState:je},components:{TreeSelect:xe},i18n:{__:ke},data:{useDispatch:Be,useSelect:He}}=wp;var qe=e=>{let{gridDisplay:t,tree:n}=e;const{switchDisplayMode:r,requestMedia:a}=Be(ye),s=(e,t)=>{e.preventDefault(),r(t)},{user:o,currentDirectory:c,flatTree:d}=He((e=>{const t=e(ye);return{user:t.getLoggedInUser(),currentDirectory:t.getCurrentDirectory(),flatTree:t.getFlatTree()}}),[]),[l,u]=je(c);c!==l&&u(c);return Ue("div",{className:"media-toolbar wp-filter"},Ue("div",{className:"media-toolbar-secondary"},Ue("div",{className:"view-switch media-grid-view-switch"},Ue("a",{href:"#view-list",onClick:e=>s(e,!1),className:t?"view-list":"view-list current"},Ue("span",{className:"screen-reader-text"},ke("Display list","bp-attachments"))),Ue("a",{href:"#view-grid",onClick:e=>s(e,!0),className:t?"view-grid current":"view-grid"},Ue("span",{className:"screen-reader-text"},ke("Display grid","bp-attachments"))))),!!n.length&&Ue("div",{className:"media-toolbar-primary"},Ue(xe,{noOptionLabel:ke("Home","bp-attachments"),onChange:e=>(e=>{u(e);const t=Ge(d,{id:e});let n={};if(t){if(n.directory=t.slug,n.parent=t.id,t.parent&&t.object){let e=Ce(i(d,t.parent).map((e=>e.slug)));"members"===t.object&&e.splice(1,0,t.object,o.id),n.path="/"+e.join("/")}t.object&&(n.object=t.object)}return a(n)})(e),selectedId:l,tree:n})))};const{template:Ye}=lodash;const{element:{createElement:We,Fragment:$e,useState:ze},components:{Modal:Xe},i18n:{__:Ke,sprintf:Qe},data:{useSelect:Ze,useDispatch:Je}}=wp;var Ve=e=>{const t=(n="bp-attachments-media-item",Ye(document.querySelector("#tmpl-"+n).innerHTML,{evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g,variable:"data"}));var n;const{title:r,vignette:a}=e,[i,s]=ze(!1),[o,c]=ze(!1),d=Ze((e=>e(ye).getRelativePath()),[]),{toggleMediaSelection:l,requestMedia:u}=Je(ye);return We($e,null,We("div",{className:o?"media-item selected":"media-item",dangerouslySetInnerHTML:{__html:t(e)},role:"checkbox",onClick:()=>(()=>{const{mimeType:t,name:n,isSelectable:r,id:a,object:i}=e;return r?(c(!o),l(a,!o)):"inode/directory"===t?u({directory:n,path:d,object:i,parent:a}):void s(!0)})()}),i&&We(Xe,{title:Qe(Ke("Details for: %s","bp-attachments"),r),onRequestClose:()=>s(!1)},a&&We("img",{src:a,className:"mediaDetails"}),!a&&We("p",null,Ke("@todo Fetch the Media properties.","bp-attachments"))))};const{element:{createElement:et,Fragment:tt},i18n:{__:nt},data:{useSelect:rt,useDispatch:at}}=wp;var it=e=>{let{gridDisplay:t,tree:n}=e;const{items:r,isSelectable:a}=rt((e=>{const t=e(ye);return{items:t.getMedia(),isSelectable:t.isSelectable()}}),[]);let i=null;return r.length&&(i=r.map((e=>et(Ve,{key:"media-item-"+e.id,id:e.id,name:e.name,title:e.title,mediaType:e.media_type,mimeType:e.mime_type,icon:e.icon,vignette:e.vignette,orientation:e.orientation,isSelected:e.selected||!1,object:e.object||"members",isSelectable:a,tree:n})))),et("div",{className:a?"media-items mode-select":"media-items"},i,!r.length&&et("p",{className:"no-media"},nt("No community media items found.","bp-attachments")))};const{domReady:st,element:{createElement:ot,render:ct,Fragment:dt},i18n:{__:lt},data:{useSelect:ut,useDispatch:pt}}=wp,mt=e=>{let{settings:t}=e;const{isGrid:n,globalSettings:r,tree:a}=ut((e=>{const t=e(ye);return{isGrid:t.isGridDisplayMode(),globalSettings:t.getSettings(),tree:t.getTree()}}),[]);if(!Object.keys(r).length){const{setSettings:e}=pt(ye);e(t)}return ot(dt,null,ot(ve,{settings:r}),ot(we,{settings:r}),ot(qe,{gridDisplay:n,tree:a}),ot(it,{gridDisplay:n,tree:a}))};st((function(){const e=window.bpAttachmentsMediaLibrarySettings||{};ct(ot(mt,{settings:e}),document.querySelector("#bp-media-library"))}))}();
//# sourceMappingURL=index.js.map
